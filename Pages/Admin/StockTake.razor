@page "/admin/stock-take"
@attribute [Authorize(Roles = "Admin, Warehouse")]
@using Microsoft.EntityFrameworkCore
@inject ApplicationDbContext DbContext
@inject ToastService ToastSvc

<h3>Kiểm kê & Điều chỉnh Tồn kho</h3>

<div class="card">
    <div class="card-body">
        <p class="card-text">
            Sử dụng giao diện này để kiểm tra và cập nhật số lượng tồn kho thực tế của sản phẩm.
        </p>

        <!-- Thanh tìm kiếm -->
        <div class="row mb-3">
            <div class="col-md-6">
                <input @bind="searchName" class="form-control" placeholder="Tìm kiếm theo tên sản phẩm..." />
            </div>
            <div class="col-md-6">
                <button class="btn btn-primary me-2" @onclick="SearchProducts"><i class="bi bi-search"></i> Tìm kiếm</button>
                <button class="btn btn-secondary" @onclick="ClearSearch"><i class="bi bi-x-circle"></i> Xóa lọc</button>
            </div>
        </div>

        @if (pagedProducts == null)
        {
            <LoadingSpinner />
        }
        else
        {
            <table class="table table-bordered">
                <thead class="table-light">
                    <tr>
                        <th>Sản phẩm</th>
                        <th class="text-center">Tồn kho Hệ thống</th>
                        <th class="text-center" style="width: 150px;">Số lượng Thực tế</th>
                        <th style="width: 120px;"></th>
                    </tr>
                </thead>
                <tbody>
                    @if (pagedProducts.Any())
                    {
                        @foreach (var product in pagedProducts)
                        {
                            <tr>
                                <td>@product.Name</td>
                                <td class="text-center">@product.StockQuantity</td>
                                <td>
                                    <InputNumber @bind-Value="product.PhysicalCount" class="form-control" />
                                </td>
                                <td class="text-center">
                                    <button class="btn btn-primary btn-sm" @onclick="() => AdjustStock(product)">
                                        Điều chỉnh
                                    </button>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr><td colspan="4" class="text-center text-muted">Không tìm thấy sản phẩm phù hợp.</td></tr>
                    }
                </tbody>
            </table>

            <!-- PHÂN TRANG -->
            @if (totalPages > 1)
            {
                <nav class="mt-3">
                    <ul class="pagination justify-content-center">
                        <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                            <button class="page-link" @onclick="() => ChangePage(currentPage - 1)">Trước</button>
                        </li>

                        @for (int i = 1; i <= totalPages; i++)
                        {
                            <li class="page-item @(currentPage == i ? "active" : "")">
                                <button class="page-link" @onclick="() => ChangePage(i)">@i</button>
                            </li>
                        }

                        <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                            <button class="page-link" @onclick="() => ChangePage(currentPage + 1)">Sau</button>
                        </li>
                    </ul>
                </nav>
            }
        }
    </div>
</div>

@code {
    private List<ProductViewModel>? allProducts;
    private IEnumerable<ProductViewModel>? pagedProducts;

    private string? searchName;

    // Phân trang
    private int currentPage = 1;
    private int pageSize = 10;
    private int totalPages = 1;

    public class ProductViewModel
    {
        public int Id { get; set; }
        public string? Name { get; set; }
        public int StockQuantity { get; set; }
        public int PhysicalCount { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadProducts();
    }

    private async Task LoadProducts()
    {
        var query = DbContext.Products.AsQueryable();

        if (!string.IsNullOrWhiteSpace(searchName))
        {
            query = query.Where(p => p.Name.Contains(searchName));
        }

        var productsFromDb = await query.OrderBy(p => p.Name).ToListAsync();

        allProducts = productsFromDb.Select(p => new ProductViewModel
        {
            Id = p.Id,
            Name = p.Name,
            StockQuantity = p.StockQuantity,
            PhysicalCount = p.StockQuantity
        }).ToList();

        totalPages = (int)Math.Ceiling((double)allProducts.Count / pageSize);
        currentPage = Math.Clamp(currentPage, 1, totalPages == 0 ? 1 : totalPages);

        pagedProducts = allProducts
            .Skip((currentPage - 1) * pageSize)
            .Take(pageSize)
            .ToList();
    }

    private async Task SearchProducts()
    {
        currentPage = 1;
        await LoadProducts();
    }

    private async Task ClearSearch()
    {
        searchName = null;
        currentPage = 1;
        await LoadProducts();
    }

    private async Task ChangePage(int page)
    {
        currentPage = page;
        await LoadProducts();
    }

    private async Task AdjustStock(ProductViewModel productVM)
    {
        if (productVM.PhysicalCount < 0)
        {
            ToastSvc.ShowToast("❌ Số lượng thực tế không thể nhỏ hơn 0.", ToastLevel.Error);
            return;
        }

        var productInDb = await DbContext.Products.FindAsync(productVM.Id);
        if (productInDb != null)
        {
            int oldQuantity = productInDb.StockQuantity;
            int change = productVM.PhysicalCount - oldQuantity;

            if (change != 0)
            {
                productInDb.StockQuantity = productVM.PhysicalCount;

                var log = new InventoryLog
                {
                    ProductId = productInDb.Id,
                    QuantityChange = change,
                    NewQuantity = productInDb.StockQuantity,
                    Reason = "Điều chỉnh kiểm kê kho"
                };
                DbContext.InventoryLogs.Add(log);

                await DbContext.SaveChangesAsync();

                productVM.StockQuantity = productVM.PhysicalCount;
                ToastSvc.ShowToast($"✅ Đã cập nhật tồn kho cho sản phẩm '{productInDb.Name}'.", ToastLevel.Success);
            }
            else
            {
                ToastSvc.ShowToast("ℹ️ Số lượng thực tế không thay đổi.", ToastLevel.Info);
            }
        }
    }
}
