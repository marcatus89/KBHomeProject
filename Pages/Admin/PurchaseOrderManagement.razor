@page "/admin/purchase-orders"
@attribute [Authorize(Roles = "Admin, Purchasing, Warehouse")]
@using Microsoft.EntityFrameworkCore
@inject ApplicationDbContext DbContext

<h3>Qu·∫£n l√Ω ƒê∆°n nh·∫≠p h√†ng</h3>

<AuthorizeView Roles="Admin, Purchasing">
    <a href="/admin/purchase-orders/add" class="btn btn-primary mb-3">T·∫°o ƒê∆°n nh·∫≠p h√†ng m·ªõi</a>
</AuthorizeView>

<!-- THANH T√åM KI·∫æM -->
<div class="row mb-3">
    <div class="col-md-4">
        <input @bind="searchTerm" class="form-control" placeholder="T√¨m theo s·ªë phi·∫øu, nh√† cung c·∫•p, tr·∫°ng th√°i..." />
    </div>
    <div class="col-md-3">
        <button class="btn btn-primary me-2" @onclick="SearchPurchaseOrders">T√¨m ki·∫øm</button>
        <button class="btn btn-secondary" @onclick="ClearSearch">X√≥a l·ªçc</button>
    </div>
</div>

@if (pagedOrders == null)
{
    <LoadingSpinner />
}
else if (!pagedOrders.Any())
{
    <div class="alert alert-info mt-4">
        Kh√¥ng c√≥ ƒë∆°n nh·∫≠p h√†ng n√†o ph√π h·ª£p.
    </div>
}
else
{
    <table class="table table-hover">
        <thead>
            <tr>
                <th>S·ªë Phi·∫øu</th>
                <th>Nh√† cung c·∫•p</th>
                <th>Ng√†y ƒë·∫∑t h√†ng</th>
                <th>Tr·∫°ng th√°i</th>
                <th>X√°c nh·∫≠n</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var po in pagedOrders)
            {
                <tr>
                    <td><strong>@po.PurchaseOrderNumber</strong></td>
                    <td>@po.Supplier?.Name</td>
                    <td>@po.OrderDate.ToString("dd/MM/yyyy")</td>
                    <td>
                        <span class="badge @(po.Status == "ƒê√£ nh·∫≠n h√†ng" ? "bg-success" : "bg-warning text-dark")">
                            @po.Status
                        </span>
                    </td>
                    <td>
                        <a href="@($"/admin/purchase-orders/{po.Id}")" class="btn btn-sm btn-info">
                            Xem/Nh·∫≠n h√†ng
                        </a>
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <!-- PH√ÇN TRANG -->
    @if (totalPages > 1)
    {
        <nav class="mt-3">
            <ul class="pagination justify-content-center">
                <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                    <button class="page-link" @onclick="() => ChangePage(currentPage - 1)">Tr∆∞·ªõc</button>
                </li>

                @for (int i = 1; i <= totalPages; i++)
                {
                    <li class="page-item @(i == currentPage ? "active" : "")">
                        <button class="page-link" @onclick="() => ChangePage(i)">@i</button>
                    </li>
                }

                <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                    <button class="page-link" @onclick="() => ChangePage(currentPage + 1)">Sau</button>
                </li>
            </ul>
        </nav>
    }
}

@code {
    private List<PurchaseOrder>? allOrders;
    private IEnumerable<PurchaseOrder>? pagedOrders;

    private string? searchTerm;

    // Ph√¢n trang
    private int currentPage = 1;
    private int pageSize = 10;
    private int totalPages = 1;

    protected override async Task OnInitializedAsync()
    {
        await LoadPurchaseOrders();
    }

    private async Task LoadPurchaseOrders()
    {
        var query = DbContext.PurchaseOrders
            .Include(po => po.Supplier)
            .AsQueryable();

        // üîç T√¨m ki·∫øm theo s·ªë phi·∫øu, t√™n nh√† cung c·∫•p, ho·∫∑c tr·∫°ng th√°i
        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            searchTerm = searchTerm.Trim().ToLower();
            query = query.Where(po =>
                po.PurchaseOrderNumber.ToLower().Contains(searchTerm) ||
                (po.Supplier != null && po.Supplier.Name.ToLower().Contains(searchTerm)) ||
                po.Status.ToLower().Contains(searchTerm));
        }

        // üìã L·∫•y to√†n b·ªô k·∫øt qu·∫£
        allOrders = await query
            .OrderByDescending(po => po.OrderDate)
            .ToListAsync();

        // üìÑ T√≠nh s·ªë trang
        totalPages = (int)Math.Ceiling((double)allOrders.Count / pageSize);
        if (totalPages == 0) totalPages = 1;

        // üßæ L·∫•y d·ªØ li·ªáu trang hi·ªán t·∫°i
        pagedOrders = allOrders
            .Skip((currentPage - 1) * pageSize)
            .Take(pageSize)
            .ToList();
    }

    private async Task SearchPurchaseOrders()
    {
        currentPage = 1;
        await LoadPurchaseOrders();
    }

    private async Task ClearSearch()
    {
        searchTerm = null;
        currentPage = 1;
        await LoadPurchaseOrders();
    }

    private async Task ChangePage(int page)
    {
        currentPage = page;
        await LoadPurchaseOrders();
    }
}
