@page "/admin/orders"
@attribute [Authorize(Roles = "Admin, Sales, Warehouse, Logistics")]
@using Microsoft.EntityFrameworkCore
@inject ApplicationDbContext DbContext
@inject AuthenticationStateProvider AuthenticationStateProvider

<h3>Qu·∫£n l√Ω ƒê∆°n h√†ng</h3>

<!-- THANH T√åM KI·∫æM -->
<div class="row mb-3">
    <div class="col-md-3">
        <input @bind="searchTerm" class="form-control" placeholder="T√¨m ID / T√™n KH / Tr·∫°ng th√°i..." />
    </div>
    <div class="col-md-2">
        <button class="btn btn-primary me-2" @onclick="SearchOrders">T√¨m ki·∫øm</button>
        <button class="btn btn-secondary" @onclick="ClearSearch">X√≥a l·ªçc</button>
    </div>
</div>

@if (pagedOrders == null)
{
    <LoadingSpinner />
}
else if (!pagedOrders.Any())
{
    <div class="alert alert-info mt-4">
        Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o ph√π h·ª£p v·ªõi vai tr√≤ c·ªßa b·∫°n ·ªü th·ªùi ƒëi·ªÉm hi·ªán t·∫°i.
    </div>
}
else
{
    <table class="table table-striped table-hover">
        <thead class="thead-dark">
            <tr>
                <th>ID ƒê∆°n h√†ng</th>
                <th>T√™n Kh√°ch h√†ng</th>
                <th>Ng√†y ƒê·∫∑t</th>
                <th>T·ªïng ti·ªÅn</th>
                <th>Tr·∫°ng th√°i</th>
                <th>H√†nh ƒë·ªông</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var order in pagedOrders)
            {
                <tr>
                    <td>@order.Id</td>
                    <td>@order.CustomerName</td>
                    <td>@order.OrderDate.ToString("dd/MM/yyyy HH:mm")</td>
                    <td>@order.TotalAmount.ToString("n0") VNƒê</td>
                    <td><span class="badge @GetStatusBadgeClass(order.Status)">@order.Status</span></td>
                    <td>
                        <a href="@($"admin/orders/{order.Id}")" class="btn btn-sm btn-secondary">Xem chi ti·∫øt</a>
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <!-- PH√ÇN TRANG -->
    @if (totalPages > 1)
    {
        <nav>
            <ul class="pagination justify-content-center">
                <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                    <button class="page-link" @onclick="() => ChangePage(currentPage - 1)">Tr∆∞·ªõc</button>
                </li>

                @for (int i = 1; i <= totalPages; i++)
                {
                    <li class="page-item @(i == currentPage ? "active" : "")">
                        <button class="page-link" @onclick="() => ChangePage(i)">@i</button>
                    </li>
                }

                <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                    <button class="page-link" @onclick="() => ChangePage(currentPage + 1)">Sau</button>
                </li>
            </ul>
        </nav>
    }
}

@code {
    private List<Order>? allOrders;
    private IEnumerable<Order>? pagedOrders;

    private string? searchTerm;

    // Ph√¢n trang
    private int currentPage = 1;
    private int pageSize = 10;
    private int totalPages = 1;

    protected override async Task OnInitializedAsync()
    {
        await LoadOrders();
    }

    private async Task LoadOrders()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        var query = DbContext.Orders.AsQueryable();

        // ‚öôÔ∏è L·ªçc theo vai tr√≤
        if (!user.IsInRole("Admin"))
        {
            var allowedStatuses = new HashSet<string>();

            if (user.IsInRole("Sales"))
                allowedStatuses.Add("Ch·ªù x√°c nh·∫≠n");
            if (user.IsInRole("Warehouse"))
                allowedStatuses.Add("ƒê√£ thanh to√°n");
            if (user.IsInRole("Logistics"))
            {
                allowedStatuses.Add("S·∫µn s√†ng giao h√†ng");
                allowedStatuses.Add("ƒêang giao");
            }

            if (allowedStatuses.Count > 0)
                query = query.Where(o => allowedStatuses.Contains(o.Status));
            else
                query = query.Where(o => false);
        }

        // üîç T√¨m ki·∫øm theo ID, T√™n kh√°ch h√†ng, ho·∫∑c Tr·∫°ng th√°i
        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            searchTerm = searchTerm.Trim().ToLower();
            query = query.Where(o =>
                o.Id.ToString().Contains(searchTerm) ||
                o.CustomerName.ToLower().Contains(searchTerm) ||
                o.Status.ToLower().Contains(searchTerm));
        }

        allOrders = await query.OrderByDescending(o => o.OrderDate).ToListAsync();

        // üìÑ T√≠nh s·ªë trang
        totalPages = (int)Math.Ceiling((double)allOrders.Count / pageSize);
        if (totalPages == 0) totalPages = 1;

        // üßæ Chia trang
        pagedOrders = allOrders
            .Skip((currentPage - 1) * pageSize)
            .Take(pageSize)
            .ToList();
    }

    private async Task SearchOrders()
    {
        currentPage = 1;
        await LoadOrders();
    }

    private async Task ClearSearch()
    {
        searchTerm = null;
        currentPage = 1;
        await LoadOrders();
    }

    private async Task ChangePage(int page)
    {
        currentPage = page;
        await LoadOrders();
    }

    private string GetStatusBadgeClass(string status)
    {
        return status switch
        {
            "Ho√†n th√†nh" => "bg-success",
            "ƒê√£ h·ªßy" => "bg-danger",
            "ƒêang giao" => "bg-primary",
            "S·∫µn s√†ng giao h√†ng" => "bg-warning text-dark",
            "Ch·ªù thanh to√°n" => "bg-info text-dark",
            "Ch·ªù x√°c nh·∫≠n" => "bg-secondary",
            _ => "bg-secondary"
        };
    }
}
